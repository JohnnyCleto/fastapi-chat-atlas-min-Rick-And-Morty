<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Entrar — Chat Multiverso</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0f172a;color:#e6eef8;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:linear-gradient(135deg,#111827ee,#0b1224ee);padding:28px;border-radius:12px;width:960px;max-width:96%;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:12px;margin-top:12px}
    .col{flex:1}
    button{padding:10px 14px;border-radius:8px;border:0;background:#7c3aed;color:white;cursor:pointer}
    #characters{display:flex;flex-wrap:wrap;gap:8px;max-height:300px;overflow:auto;padding:6px;border:1px dashed rgba(255,255,255,0.06);border-radius:8px}
    .char{cursor:pointer;border-radius:8px;padding:6px;background:rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center;width:220px;}
    .char img{width:48px;height:48px;border-radius:8px;object-fit:cover}
    .meta{font-size:13px}
    label{font-size:13px;display:block;margin-bottom:6px}
    input,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;width:100%}
    footer{margin-top:16px;text-align:right;font-size:12px;color:rgba(255,255,255,0.6)}
  </style>
</head>
<body>
  <div class="card">
    <h1>Conecte-se com um personagem (escolha um perfil)</h1>
    <p>Escolha um personagem do Rick & Morty (carregado da API) para usar no chat — seu avatar será salvo localmente.</p>

    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <label>Pesquisa (nome)</label>
        <input id="search" placeholder="Pesquisar personagem..." />
        <div id="characters">Carregando...</div>
      </div>

      <div style="width:320px">
        <label>Perfil atual</label>
        <div id="profile" style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)">
          Nenhum personagem selecionado
        </div>

        <div style="margin-top:12px">
          <label>Entrar no Chat</label>
          <input id="room" placeholder="Sala (ex: general)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="enterBtn">Entrar</button>
            <button id="createRoom">Criar sala</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Entrar sala privada</label>
          <input id="privateRoom" placeholder="Sala privada" />
          <input id="privatePass" placeholder="Senha" />
          <button id="joinPrivate">Entrar privada</button>
        </div>
      </div>
    </div>

    <footer>Chat Multiverso • Escolha perfil e entre em salas públicas ou privadas</footer>
  </div>

  <script>
    // front-end: busca personagens da API pública e permite salvar perfil no localStorage
    const charactersEl = document.getElementById('characters');
    const profileEl = document.getElementById('profile');
    const searchEl = document.getElementById('search');
    const enterBtn = document.getElementById('enterBtn');
    const createRoomBtn = document.getElementById('createRoom');
    const roomInput = document.getElementById('room');
    const privateRoom = document.getElementById('privateRoom');
    const privatePass = document.getElementById('privatePass');
    const joinPrivateBtn = document.getElementById('joinPrivate');

    let user = JSON.parse(localStorage.getItem('user')) || null;

    function renderProfile(){
      if(!user){ profileEl.innerHTML = 'Nenhum personagem selecionado'; return; }
      profileEl.innerHTML = `<div style="display:flex;gap:10px;align-items:center">
          <img src="${user.avatar}" width="64" height="64" style="border-radius:8px" />
          <div>
            <div style="font-weight:600">${user.name}</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.6)">Perfil salvo localmente</div>
          </div>
        </div>`;
    }

    async function fetchCharacters(page=1){
      charactersEl.innerHTML = 'Carregando...';
      try{
        const res = await fetch(`https://rickandmortyapi.com/api/character/?page=${page}`);
        const data = await res.json();
        renderChars(data.results || []);
      }catch(e){
        charactersEl.innerHTML = 'Erro ao carregar personagens.';
      }
    }

    function renderChars(chars){
      charactersEl.innerHTML = '';
      chars.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'char';
        div.innerHTML = `<img src="${ch.image}" /><div class="meta"><strong>${ch.name}</strong><div style="font-size:12px;color:rgba(255,255,255,0.6)">${ch.species} — ${ch.status}</div></div>`;
        div.onclick = () => {
          user = { name: ch.name, avatar: ch.image };
          localStorage.setItem('user', JSON.stringify(user));
          renderProfile();
          alert('Personagem selecionado: ' + ch.name);
        };
        charactersEl.appendChild(div);
      });
    }

    searchEl.addEventListener('keyup', async (e) => {
      const v = e.target.value.trim();
      if(!v) return fetchCharacters();
      charactersEl.innerHTML = 'Buscando...';
      try{
        const res = await fetch(`https://rickandmortyapi.com/api/character/?name=${encodeURIComponent(v)}`);
        const data = await res.json();
        renderChars(data.results || []);
      }catch(err){
        charactersEl.innerHTML = 'Nenhum personagem encontrado';
      }
    });

    enterBtn.onclick = () => {
      const room = (roomInput.value || 'general').trim();
      if(!user) return alert('Escolha um personagem antes de entrar.');
      localStorage.setItem('room', room);
      window.location.href = `/chat?room=${encodeURIComponent(room)}`;
    };

    createRoomBtn.onclick = async () => {
      const room = prompt('Nome da sala:').trim();
      if(!room) return;
      // cria sala via API
      await fetch('/rooms', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: room, is_private: false })
      });
      localStorage.setItem('room', room);
      window.location.href = `/chat?room=${encodeURIComponent(room)}`;
    };

    joinPrivateBtn.onclick = async () => {
      const room = privateRoom.value.trim();
      const pass = privatePass.value;
      if(!user) return alert('Escolha um personagem antes de entrar.');
      if(!room) return alert('Informe sala privada');
      const res = await fetch(`/rooms/${encodeURIComponent(room)}/join`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ password: pass })
      });
      if(res.status === 200){
        localStorage.setItem('room', room);
        window.location.href = `/chat?room=${encodeURIComponent(room)}`;
      }else{
        const j = await res.json();
        alert('Erro ao entrar: ' + (j.detail || 'ERRO'));
      }
    };

    // inicializa
    renderProfile();
    fetchCharacters();
  </script>
</body>
</html>
